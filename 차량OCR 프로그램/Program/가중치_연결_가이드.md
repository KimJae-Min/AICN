# 사하구청 배포용 가중치 연결 가이드

프로그램 코드를 수정하지 않고도 최신 학습 가중치를 교체할 수 있도록 `my_models.py`는
두 가지 방법을 지원합니다. 사하구청에 배포할 때 아래 절차만 따르면 됩니다.

## 1. 기본 구조
- `my_models.py` : 번호판 검출·OCR 추론 코드를 모두 포함(추론에 필요한 구조만 내장)
- `weights_config.json` : 검출/인식 가중치 파일 경로를 기록하는 설정 파일
- **최종 학습 가중치 2종** : `plate_detector`(YOLO)와 `ocr`(AttnOCR)

## 2. 가장 간단한 방법 (weights_config.json 수정)
1. 학습 결과로 얻은 **번호판 검출 가중치**(`.pt`)와 **OCR 가중치** 파일을
   `차량OCR 프로그램/Program/` 폴더 안에 복사합니다.
2. `weights_config.json`을 열어 아래 예시처럼 파일명을 원하는 이름으로 변경합니다.
   ```json
   {
     "plate_detector": "plate_detector_saha.pt",
     "ocr": "ocr_saha.pt"
   }
   ```
3. Streamlit 앱을 실행하면 새로운 가중치가 자동으로 로드됩니다.

## 3. 환경변수로 경로 지정 (테스트/여러 버전 병행 시)
- 터미널에서 다음과 같이 환경변수를 지정한 뒤 앱을 실행하면 설정 파일보다
  **환경변수 값이 우선** 적용됩니다.
  ```bash
  export PLATE_DET_WEIGHTS="/path/to/custom_detector.pt"
  export PLATE_OCR_WEIGHTS="/path/to/custom_ocr.pt"
  streamlit run app.py
  ```
- 배포 서버에서 여러 모델을 번갈아 테스트하거나 임시 경로를 쓸 때 유용합니다.

## 4. 오류가 날 때 확인할 부분
- 경로에 한글이 포함되어도 되지만, 윈도우/리눅스 간 이동 시 인코딩 문제가 생길 수
  있으므로 가능하면 영문 폴더명을 권장합니다.
- 파일이 없을 경우 `FileNotFoundError` 메시지로 정확한 경로를 알려주니,
  해당 위치에 가중치가 존재하는지 다시 확인합니다.

이 가이드를 따라 가중치 파일만 교체하면 Streamlit 앱 UI는 그대로 유지되며,
사하구청 환경에서도 동일하게 동작합니다.

## 5. 사하구청에 전달해야 할 최소 파일 묶음
사하구청 측에는 학습/연구용 자료 전체가 아니라 **실행에 필요한 Program 폴더**와
최종 가중치 파일만 전달하면 됩니다. 이제 `my_models.py` 안에 추론용 네트워크 정의를
직접 포함했기 때문에, 학습 스크립트가 들어 있는 `OCR/`, `Obj Detection/` 폴더를
포함시키지 않아도 됩니다. 배포용 압축 파일을 만들 때는 아래 항목만 확인하면 됩니다.

| 포함 여부 | 경로/파일 | 설명 |
|-----------|-----------|------|
|✅|`Program/app.py`|Streamlit UI 진입점|
|✅|`Program/my_models.py`|가중치 로딩 및 추론 로직(추론용 모델 구조 포함)|
|✅|`Program/weights_config.json`|가중치 파일 경로 설정|
|✅|`Program/가중치_연결_가이드.md` (본 문서)|현장 교체 방법 안내|
|✅|`Program/plate_detector.pt` (예시)|최신 번호판 검출 가중치|
|✅|`Program/ocr_model.pt` (예시)|최신 OCR 가중치|
|선택|`Program/OCR/`, `Program/Obj Detection/`|추가 학습·재현이 필요할 때만 포함|

- 위 목록만 있으면 사하구청 PC에서도 `streamlit run app.py`로 바로 실행할 수 있습니다.
- 만약 추후에 의존 패키지 설치가 필요하다면, `pip freeze`로 만든 `requirements.txt`를 추가로 전달하면 설치가 수월합니다.

## 6. 전달용 ZIP 자동 생성 스크립트
매번 수동으로 파일을 모으기 번거롭다면 `prepare_saha_bundle.py`를 사용하세요.

```bash
cd 차량OCR\ 프로그램/Program
python prepare_saha_bundle.py
```

- `Program/dist/` 안에 `saha_bundle_YYYYMMDD_HHMMSS.zip` 파일이 생성되며, 위 표의 필수 항목과 `weights_config.json`이 가리키는 가중치 파일이 자동으로 포함됩니다.
- `python prepare_saha_bundle.py --include-training` 옵션을 주면 `OCR/`, `Obj Detection/` 폴더도 함께 묶을 수 있습니다.
- `--output` 옵션으로 저장 위치를 직접 지정할 수 있습니다. 예) `--output ../saha_release.zip`
